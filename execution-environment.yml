version: 3

images:
  base_image:
    name: quay.io/centos/centos:stream9

dependencies:
  ansible_core:
    package_pip: ansible-core==2.20.*
  ansible_runner:
    package_pip: ansible-runner

  galaxy: galaxy_requirements.yml
  python: pip_requirements.txt
  system: bindep.txt

additional_build_steps:
  prepend_base:
    # Repo setup for python3.11 on Stream 9
    - RUN dnf -y install dnf-plugins-core ca-certificates && dnf clean all
    - RUN dnf config-manager --set-enabled crb
    - RUN dnf -y install epel-release && dnf clean all

    # Install Python 3.11 + pip + git (git needed for your git-based collections)
    - RUN dnf -y install python3.11 python3.11-pip git && dnf clean all

    # Ensure ansible-builder uses python3.11 (PYCMD is what their scripts call)
    - ENV PYCMD=/usr/bin/python3.11

    # Modern pip before installing ansible-core/runner
    - RUN $PYCMD -m pip install -U pip setuptools wheel

    # Use public PyPI unless you intentionally use a mirror
    - ENV PIP_INDEX_URL=https://pypi.org/simple
    - ENV PIP_EXTRA_INDEX_URL=
