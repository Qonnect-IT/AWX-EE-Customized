name: Build AWX Execution Environment

on:
  push: {}
  workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: awx-ee-customized

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-builder
        run: |
          python -m pip install --upgrade pip
          pip install ansible-builder

      - name: Create build context from execution-environment.yml
        run: |
          ansible-builder create -v3 -f execution-environment.yml

      - name: Dockerhub login
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
        run: |
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USER" --password-stdin

      - name: Determine ansible-core tag
        id: versions
        run: |
          AC_LINE=$(grep -E '^\s*package_pip:\s*ansible-core==' execution-environment.yml | head -n1 || true)
          if [ -z "$AC_LINE" ]; then
            echo "ansible_core_tag=ansible-core-unknown" >> "$GITHUB_OUTPUT"
          else
            AC_VER=$(echo "$AC_LINE" | sed -E 's/.*ansible-core==([^"[:space:]]+).*/\1/' | sed 's/\.\*$//')
            echo "ansible_core_tag=ansible-core-${AC_VER}" >> "$GITHUB_OUTPUT"
          fi
          echo "sha_tag=sha-$(echo "${GITHUB_SHA}" | cut -c1-7)" >> "$GITHUB_OUTPUT"

      - name: Build the Docker image (latest + ansible-core tag + sha)
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          ANSIBLE_CORE_TAG: ${{ steps.versions.outputs.ansible_core_tag }}
          SHA_TAG: ${{ steps.versions.outputs.sha_tag }}
        run: |
          docker build ./context \
            -f ./context/Containerfile \
            -t "${DOCKERHUB_USER}/${IMAGE_NAME}:latest" \
            -t "${DOCKERHUB_USER}/${IMAGE_NAME}:${ANSIBLE_CORE_TAG}" \
            -t "${DOCKERHUB_USER}/${IMAGE_NAME}:${SHA_TAG}"

      - name: Push to Dockerhub (all tags)
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
          ANSIBLE_CORE_TAG: ${{ steps.versions.outputs.ansible_core_tag }}
          SHA_TAG: ${{ steps.versions.outputs.sha_tag }}
        run: |
          docker push "${DOCKERHUB_USER}/${IMAGE_NAME}:latest"
          docker push "${DOCKERHUB_USER}/${IMAGE_NAME}:${ANSIBLE_CORE_TAG}"
          docker push "${DOCKERHUB_USER}/${IMAGE_NAME}:${SHA_TAG}"
